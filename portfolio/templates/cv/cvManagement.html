{% extends "defaultTemplate.html" %}

{% block title %}<title>KJ Chow CV</title>{% endblock %}

{% block content %}
    <header class="major">
        <h2>CV</h2>
    </header>

    <!-- One -->
    <section id="cvUpload">
        <header class="major">
            <h2>Upload</h2>
        </header>
        <form action="{% url 'cv:cvManagement' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input 
                type="file"
                id="cvFileUpload"
                name="cvFileUpload"
                accept="application/pdf"
                required
            />
            <input 
                type="submit"
                name="cvUploadName"
            />
        </form>
    </section>

    <section id="cvVersions">
        <header class="major">
            <h2>Versions</h2>
        </header>
        <table id="cvTable">
            <tr>
                <th>Date</th>
                <th>CV</th>
                <th>Active</th>
            </tr>
        </table>
    </section> 
    <!-- base64 to Blob -->
    <script>
        var cv_files = JSON.parse("{{ cv_files|escapejs }}");
        var table = document.getElementById("cvTable");
        const contentType = "application/pdf";
        const b64toBlob = (b64Data, contentType = "", sliceSize = 512) => {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize),
                    byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);

                byteArrays.push(byteArray);
            }

            const blob = new Blob(byteArrays, {
                type: contentType
            });
            return blob;
        };
        
        for (const [key, _] of Object.entries(cv_files)) {
            // data handling
            var cvName = cv_files[key][0]
            var cvDate = cv_files[key][1]
            var b64Data = cv_files[key][2];
            var blob = b64toBlob(b64Data, contentType);
            var blobUrl = URL.createObjectURL(blob);
            var activeCV = cv_files[key][3];

            // row handling
            var row = table.insertRow(1);
            var cell_1 = row.insertCell(0);
            cell_1.innerHTML = `<p>${cvName}</p><p>${cvDate}</p>`
            var cell_2 = row.insertCell(1);
            cell_2.innerHTML = `
                <section>
                    <a href=${blobUrl}>View Full Screen</a>
                    <div>
                        <iframe id=cv_${key} style='display:none;' src=${blobUrl}></iframe>
                    </div>
                    <p style="cursor:pointer" onclick="iframeExpand(${key})">Show/Hide</p>
                </section>`
            var cell_3 = row.insertCell(2);
            if(activeCV){
                cell_3.innerHTML = `Active`
            }else{
                cell_3.innerHTML = `
                <form action="{% url 'cv:cvManagement' %}" method="POST">
                    {% csrf_token %}
                    <button name="activateCV" value="${key}">Activate</button>
                </form>
                <form action="{% url 'cv:cvManagement' %}" method="POST">
                    {% csrf_token %}
                    <button name="deleteCV" value="${key}">Delete</button>
                </form>`
            }
        }
    </script>
    <!-- alerts, expand and refresh -->
    <script>
        // page refresh does not resubmit data
        if ( window.history.replaceState ) {
            window.history.replaceState( null, null, window.location.href );
        }
        // show/hide iframe
        function iframeExpand(string_id){
            iframeEle = document.getElementById(`cv_${string_id}`);
            if(iframeEle.style.display=="none"){
                iframeEle.style.display = "block";
            }else{
                iframeEle.style.display = "none";
            }
        }
        // alert
        var error_message = "{{ error_message }}";
        if(error_message){
            alert(error_message);
        };
    </script>
{% endblock %}